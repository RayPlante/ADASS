% This is the aspauthor.tex LaTeX file
% Copyright 2010, Astronomical Society of the Pacific Conference Series

\documentclass[11pt,twoside,hyphens]{article} %Added hyphens so the nickballastronomer URL linebreaks correctly
\usepackage{asp2010}

\resetcounters

\bibliographystyle{asp2010}

\markboth{Nicholas M. Ball}{CANFAR+Skytree}

\begin{document}

\title{CANFAR+Skytree: A Cloud Computing and Data Mining System for Astronomy}
\author{Nicholas M. Ball$^1$
\affil{$^1$National Research Council Canada, 5071 West Saanich Road, Victoria, BC V9E 2E7}}

\begin{abstract}
This is a companion Focus Demonstration article to the CANFAR+Skytree poster (\citeauthor{ball:adass12poster} \citeyear{ball:adass12poster}, this volume), demonstrating the usage of the Skytree machine learning software on the Canadian Advanced Network for Astronomical Research (CANFAR) cloud computing system. CANFAR+Skytree is the world's first cloud computing system for data mining in astronomy.
\end{abstract}

\section{Introduction}

CANFAR\footnote{\url{http://canfar.phys.uvic.ca}} \citep{gaudet:canfar} is the cloud computing system of the Canadian Astronomy Data Centre (CADC). It is the first system designed to provide this capability to astronomers. Skytree is the world's most advanced machine learning software. It acts as a machine learning server to allow advanced data mining on large data. The CANFAR+Skytree combination allows Skytree to be run on up to 500 cores simultaneously, the current size of the CANFAR system. In this paper, we reproduce the Focus Demonstration session given at the conference, showing an example Skytree run, how to access and use CANFAR, and how to use the two in concert.

\section{Running Skytree}

Skytree can be run interactively on a UNIX or Mac OS X system. Installation is by unzipping the tarfile into a directory

\begin{verbatim}
tar -zxf SkytreeServer11.3.2.tgz
\end{verbatim}

This results in a directory containing the skytree-server executable, an example dataset, a .lic license file, and some others.

\subsection{Example: Nearest Neighbors}

We show the running of the nearest neighbors algorithm, {\tt allkn} on the example dataset supplied with the software. The dataset is from the Sloan Digital Sky Survey, reflecting the company's academic roots and links to astronomy. It contains just under 100,000 rows (galaxies), and four SDSS colors.

Begin by selecting suitable rows:

\begin{verbatim}
cd SkytreeServer11.3.2/datasets
awk -F, '(NF==3 || NF==7)' sdss100kx4.skytree \
   > sdss100kx4.subsample.skytree
cd ..
\end{verbatim}

This is typical of analysis using Skytree: as with any data mining, one prepares the data first. Some data preparation and results analysis tools are now available with the software, but the machine learning invocation remains separate, on whatever file it is passed. Input files are typically ASCII format. The .skytree represents an explicit header style in which datatypes are given that enables some algorithms to run faster, but the file is otherwise ASCII CSV.

We then run {\tt allkn}:

\begin{verbatim}
./skytree-server allkn \
   --references_in=datasets/sdss100kx4.subsample.skytree \
   --k_neighbors=1 \
   --distances_out=distances.out \
   --indices_out=indices.out
\end{verbatim}

The program is invoked via the {\tt skytree-server} executable, the algorithm name (in this case {\tt allkn}), and passed arguments as appropriate to the algorithm. In this case, the input file, {\tt references\_in}, the number of neighbors to find, 1, and the neighbor distances and file positions as output. The typical appearance of this run in the terminal is shown in Figure \ref{Fig: Terminal}. Each algorithm is fully documented if invoked with the {\tt --help} argument.

\begin{figure}
\plotone{F5_terminal.ps}
\caption{Typical Skytree invocation on the terminal, showing the {\tt allkn} run detailed in the text. \label{Fig: Terminal}}
\end{figure}

Once run, we have obtained the neighbor distances, and, via the indices, which objects are the neighbors. These may be cast into a suitable form for visualization, e.g.

\begin{verbatim}
paste -d \\0 distances.out indices.out \
   datasets/sdss100kx4.subsample.skytree > tmp.csv
sed s/'header,double:1,header,unsigned_int:1,header,meta:3,\
   double:4'/'#nn,ind,label,target,id,ug,gr,ri,iz'/g tmp.csv \
   > results_allkn.csv
\end{verbatim}

\noindent which may be visualized in a program such as TOPCAT \citep{taylor:topcat}. Again, this is typical of an analysis with Skytree: it outputs results, which are then further processed.

In this case, if one histograms the distances, selects those with large distances, and plots a color-color plot, e.g., $u-g$ versus $g-r$ ($ug$ vs. $gr$), it is clear that {\tt allkn} has found outliers. Obviously such a measure in isolation is crude (one might want to calculate, for example, the local outlier factor), but it exemplifies the kind of analysis that can be rapidly built up using data mining.

\section{Running Software on CANFAR (Including Skytree)}

To access CANFAR requires a CADC account, and a CANFAR account. These are set up via the CADC webpage at \url{http://www.cadc-ccda.hia-iha.nrc-cnrc.gc.ca}, and by request to {\tt CanfarHelp@nrc-cnrc.gc.ca} . Once given an account, access CANFAR via ssh:

\begin{verbatim}
desktop> ssh <username>@canfar.dao.nrc.ca
\end{verbatim}

This places the user on the CANFAR head node, from which it is possible to utilize software interactively, and run short processing jobs (e.g., a half hour or less). X Windows and X-forwarding is supported. Thus, one may install software as desired, including Skytree, and run it as above. Detailed usage of CANFAR is documented on the wiki, at \url{http://canfar.phys.uvic.ca/wiki}.

\subsection{Virtual Machines}

Rather than installing software in one's home directory on the CANFAR head node, the bulk of the interaction with the system is via a virtual machine (VM). The VM is created by the user, who then has full root access to it. Access is via ssh:

\begin{verbatim}
CANFAR> vmcreate <vmname>
CANFAR> vmssh <vmname>
\end{verbatim}

To shut down the VM, use {\tt vmstop}. One a VM exists, one does not {\tt vmcreate} it again, but starts it using {\tt vmstart}.

\subsection{VOSpace}

CANFAR has implemented, via International Virtual Observatory Alliance protocols, a filesystem, VOSpace, that gives CANFAR users access to hundreds of terabytes of persistent storage. Access to VOSpace requires an X.509 certificate, which can be obtained by the user via \url{http://www.cadc-ccda.hia-iha.nrc-cnrc.gc.ca/cadcbin/auth/archive/accountDetails.pl}. VOSpace can be mounted as a filesystem, which enables it to be treated as another directory tree, and accessed from one's desktop, the CANFAR head node, one's VM, or a batch job.

\subsection{Batch Jobs}

Batch jobs are managed by the Condor scheduling system. To prepare a batch job, a Condor submission file and a calling script are created on the CANFAR head node, which in turn calls a script on the VM. To submit a job, the VM is shutdown, and the Condor submission command is given:

\begin{verbatim}
CANFAR> vmstop <vmname>
CANFAR> condor_submit <job>.condor
\end{verbatim}

One may then monitor the execution of the job via the usual Condor commands, e.g., {\tt condor\_q <username>}. Jobs have access to scratch disk staging space, and the results are copied back to VOSpace.

\subsection{Running CANFAR+Skytree}

Skytree is invoked on the command line or a script as part of one's analysis. Running in batch allows up to 500 instances of Skytree to be run simultaneously.

\section{Conclusions}

CANFAR+Skytree represents world's first cloud computing system for data mining in astronomy, and is open for use by any interested member of the astronomical community. For further details on usage, see the poster paper (\citeauthor{ball:adass12poster} \citeyear{ball:adass12poster}, this volume), or visit the CANFAR+Skytree website at \url{https://sites.google.com/site/\-nickballastronomer}.

% \subsection{The Author Checklist}
% The following checklist should be followed when writing a submission to a conference proceedings to be published by the ASP.

% \begin{itemize}
% \checklistitemize
% \item Article is within page limitations set by editor. 
% \item Paper compiles properly without errors or warnings.
% \item No fundamental modifications to the basic template are present, including special definitions, special macros, packages, \verb"\vspace" commands, font adjustments, etc. %(§ 3.3, p. 10)
% \item Commented-out text has been removed. %(§ 3.3, p. 10,11)
% \item Author and shortened title running heads are proper for the paper and shortened so page number is within the margin. %(§ 3.1, p. 4)
% \item Paper checked for general questions of format and style, including, but not limited to, the following:
% \begin{itemize}
%   \item capitalization, layout, and length of running heads, titles  and \\sections/subsections;  % (§ 3.1, p. 4) (§ 3.2, p. 5) (§ 3.3, p. 8)
%   \item page numbers within margin; % (§ 3.1, p. 4)
%   \item author names spelled correctly and full postal addresses given; % (§ 3.2, p. 5-6)
%   \item abstracts; % (§ 3.2, p. 7);
%   \item all margins---left, right, top and bottom; % (§3.1, p. 4; §3.2, p. 5; §3.3, p. 9; §3.6, p. 21);
%   \item standard font size and no Type 3 fonts; %(§ 3.3, pp. 10-11; § 3.6, p. 23; § 4.2, p. 25);
%   \item spacing; % (§ 3.3, pp. 9-10);
%   \item section headings. % (§ 3.3; p. 8).
% \end{itemize}
% \item All tables are correctly positioned within margins, are properly formatted, and are referred to in the text.  %(§ 3.5, pp. 16-20)
% \item All figures are correctly positioned within margins, are minimum 300 dpi resolution, not too dark or too light, do not contain embedded fonts, and are referred to in the text.  All labeling or text will be legible with 10\% reduction.  Questionable images printed, checked and replaced if necessary.  Figures do not cover text or running heads, and proper permissions have been granted and acknowledged.  %(§ 3.6, pp. 21-24)
% \item All acknowledgments and discussions are in proper format.  % (pp. 11-12, p. 20)
% \item If there are acknowledgments at the end of the article, ensure that the author has used
% the \verb"\acknowledgments" command and not the commands
% \\ \verb"\begin{Acknowledgments}", \verb"\end{Acknowledgments}".
% Acknowledgments should only be used for thanking institutions,
% groups, and individuals who have directly contributed to the work.
% \item All references quoted in the text are listed in the bibliography; all items in the bibliography have been referred to in the text.  % (§ 4, pp. 24-28)
% \item All bibliography entries are in the proper format, using one of the referencing styles given. Each of the references is bibliographically complete, including full names of authors, editors, publishers, place of publication, page numbers, years, etc. % (§§ 4.2-4.3, pp. 25-28)
% \item A complete Bib\TeX\ file is ready to submit to the editor.
% \item References to preprints replaced with publication information when possible.
% \end{itemize}

\acknowledgements This research used the facilities of the Canadian Astronomy Data Centre, operated by the National Research Council of Canada with the support of the Canadian Space Agency. Funding for CANFAR was provided by CANARIE via the Network Enabled Platforms Supporting Virtual Organisations program. The author thanks D. Schade, A. Gray and M. Hack for their contributions to this work.

\bibliography{../../editor}

\end{document}
