
\resetcounters

\markboth{Friedel}{The CARMA Data Reduction Pipeline}

\title{The \ssindex{observatories!Earth-based!CARMA}CARMA Data Reduction \ssindex{data!pipelines!reduction}Pipeline}
\author{Douglas N. Friedel}
\affil{Department of Astronomy, University of Illinois}

\aindex{Friedel, D. N.}

\begin{abstract}
The Combined Array for Millimeter-wave Astronomy (\ssindex{observatories!Earth-based!CARMA}CARMA) data reduction \ssindex{data!pipelines!reduction}pipeline has been developed to give investigators a first look at a fully reduced set of their data. It runs automatically on all data produced by the telescope as they arrive in the data archive. The \ssindex{data!pipelines!reduction}pipeline is written in \ssindex{computer languages!Python}Python and uses \ssindex{computer languages!Python}Python wrappers for \ssindex{packages!MIRIAD}MIRIAD\ooindex{MIRIAD, ascl:1106.007} subroutines for direct access to the data. It applies passband, gain and flux calibration to the data sets and produces a set of continuum and spectral line maps in both \ssindex{packages!MIRIAD}MIRIAD and \ssindex{data formats!FITS}FITS format. The \ssindex{data!pipelines!reduction}pipeline has been in production for a year and this poster will discuss the current capabilities and planned improvements.
\end{abstract}

\section{Overview}

The goal of the \ssindex{observatories!Earth-based!CARMA}CARMA Data Reduction \ssindex{data!pipelines!reduction}Pipeline is to provide the end user a calibrated and mapped data set that is of the quality produced by a typical user. Note that the \ssindex{data!pipelines!reduction}pipeline may not catch all data errors so it is strongly suggested that the end user check the data themselves. The \ssindex{data!pipelines!reduction}pipeline produces calibrated data for all windows, spectral line maps of all windows, and a continuum map (if possible), along with two text files. \verb#reduction.notes# contains a detailed explanation of what was done to the data set during calibration and reduction. \verb#reduction.script# is a standalone csh script file that will reproduce the calibration and reduction of the data, so that the end user can tweak parameters to re-run on their home system (assuming \ssindex{packages!MIRIAD}MIRIAD\ooindex{MIRIAD, ascl:1106.007} is installed). Additionally, the \ssindex{data!pipelines!reduction}pipeline script files used for the reduction are included (\ssindex{computer languages!Python}Python files in the case of the system default scripts), so that the end user may re-run the entire \ssindex{data!pipelines!reduction}pipeline on the home system, with different parameters, etc. (assuming the back end software is installed: \ssindex{packages!MIRIAD}MIRIAD (including the \ssindex{computer languages!Python}Python modules), \ssindex{computer languages!Python}Python, \ssindex{libraries!numpy}numPy).
\ooindex{CADRE, ascl:1303.017}

\section{Technical Details}

The \ssindex{data!pipelines!reduction}pipeline is fully automated and is written in \ssindex{computer languages!Python}Python ($/sim$24K lines of code), using \ssindex{packages!MIRIAD}MIRIAD\ooindex{MIRIAD, ascl:1106.007} \citep{stw95} routines to do a majority of the direct data processing. \ssindex{computer languages!Python}Python wrappers for the \ssindex{packages!MIRIAD}MIRIAD subroutines were developed to allow the \ssindex{data!pipelines!reduction}pipeline to have direct access to the data for specialized tasks (e.g. reading gain tables, observational statistics, and meta-data), rather than relying on fragile flat file output from \ssindex{packages!MIRIAD}MIRIAD\ooindex{MIRIAD, ascl:1106.007} tasks.

The \ssindex{data!pipelines!reduction}pipeline was optimized for speed by threading, at the \ssindex{computer languages!Python}Python level, many of the \ssindex{packages!MIRIAD}MIRIAD\ooindex{MIRIAD, ascl:1106.007} reduction tasks that are window specific (e.g. gain calibration, map creation, and cleaning).

The time it takes for a track to run through the \ssindex{data!pipelines!reduction}pipeline varies from a few minutes to many hours. It is heavily dependent on the number of mosaic pointings and size of the synthesized beam, but averages less than 30 minutes.

The \ssindex{data!pipelines!reduction}pipeline was turned on 20 Sept.\ 2011. It is successful (producing full output) on more than 95\%\footnote{This does not include unsupported modes and tracks with failing grades.} of datasets.

\section{The Process}

The \ssindex{data!pipelines!reduction}pipeline goes through the typical reduction procedures for millimeter \ssindex{astronomy!radio}radio telescope arrays.

\begin{description}
\item[Antenna Positions] The \ssindex{data!pipelines!reduction}pipeline applies the appropriate antenna position solution to the data.
\item[Passband Calibration] The \ssindex{data!pipelines!reduction}pipeline will correct each spectral window for passband effects (frequency dependent artifacts induced on the data by the sky and instrument).
\item[Flagging] The \ssindex{data!pipelines!reduction}pipeline will flag data based on a number of criteria:
\begin{description}
\item[Shadowing] The \ssindex{packages!MIRIAD}MIRIAD\ooindex{MIRIAD, ascl:1106.007} task \verb#csflag# flags data based on antenna shadowing.
\item[Gains] The \ssindex{data!pipelines!reduction}pipeline will flag calibrator data based on gains computed by the task \verb#mselfcal#. The \ssindex{data!pipelines!reduction}pipeline looks for anomalously high or low amplitude gains (cutoff values are settable in the user preferences file) and high scatter in the phase gains, and flags the data appropriately. If any flagging is done the selfcalibration solutions are recalculated before proceeding.
\item[Passband] The \ssindex{data!pipelines!reduction}pipeline analyzes the passband solution for high scatter in the phase solution (based on rms noise), and any bad windows are flagged, and calibration recomputed.
\item[System Temperatures] Any data with anomalously high system temperature (typically above 5000K) are flagged.
\item[Bad Amplitudes] High and low amplitude anomalies on source and calibrator data are flagged (based on the rms and mean values).
\item[Birdies] The \ssindex{data!pipelines!reduction}pipeline attempts to detect spectral birdies and flag the affected data. A birdie is defined as a strong, very narrow signal that is present in exactly the same channel in both sidebands.
\item[Elevation] The \ssindex{data!pipelines!reduction}pipeline will flag any data taken at high elevation ($>$87$\deg$) as the antennas can have difficulty tracking at these elevations.
\item[Unbracketed Source Data] Any source data not surrounded (in time) by gain calibrator observations will be flagged.
\end{description}
\item[Gain Calibration] The \ssindex{data!pipelines!reduction}pipeline attempts to be as cautious as possible when it computes the amplitude and phase gains from the calibrator(s).
\begin{description}
\item[Amplitude Calibration] If a planet was observed during the track the \ssindex{data!pipelines!reduction}pipeline runs \verb#bootflux# on both the planet and gain calibrator(s) to calculated the amplitude of the calibrator(s). If no planet was observed, or \verb#bootflux# fails, the \ssindex{data!pipelines!reduction}pipeline searches the data for a secondary calibrator (typically a strong non-gain calibrator such as the passband calibrator) and runs \verb#bootflux# on it and the gain calibrator(s). If this also fails then the \ssindex{data!pipelines!reduction}pipeline falls back on the internal \ssindex{packages!MIRIAD}MIRIAD\ooindex{MIRIAD, ascl:1106.007} calibrator flux table. If no flux can be determined then the selfcal solutions will be done in phase only.
\item[Phase Calibration] The \ssindex{packages!MIRIAD}MIRIAD\ooindex{MIRIAD, ascl:1106.007} task \verb#mselfcal# is used to calculated the phase (and amplitude if applicable) gains of the gain calibrator(s). Multiple gain calibrators are each handled independently. In the case of heterogeneous bandwidth configurations (e.g. a mix of 500 MHz and 32 MHz bands), the widest bandwidth windows are self calibrated. This solution is then bootstrapped to the narrow band window(s). The narrow bandwidth window(s) are then selfcalibrated (in phase only) with long time intervals (hours), in order to remove the window based phase offsets.
\item[Application to the Data] The gains from the calibrator(s) are copied and applied to the source data with \verb#gpcopy# and \verb#uvcat#. In the case of heterogeneous bandwidths the gain solutions are copied and applied incrementally with each selfcalibration solution. 
\end{description}
\item[Mapping] The \ssindex{data!pipelines!reduction}pipeline will produce several mapping products: a continuum map, spectral line maps for each window, and short and long baseline continuum maps for Sunyaevâ€“Zel'dovich effect observations, for point source subtraction.
\begin{description}
\item[Inverting] Before running \verb#invert# the \ssindex{data!pipelines!reduction}pipeline calculated the final image size based on the FWHM of the largest primary beam. It also determines an appropriate cell size based on the estimated synthesized beam. All maps are generated with \verb#options=system,mosaic#. These options will weight the data based on the system temperatures and make a mosaic map, which properly treats the data from a heterogeneous array.
\item[Cleaning] The \ssindex{data!pipelines!reduction}pipeline uses the \ssindex{packages!MIRIAD}MIRIAD\ooindex{MIRIAD, ascl:1106.007} task \verb#mossdi# to create the clean maps. It's default is to clean the inner quarter of all single pointing observations and the FWHM regions of the 10m antennas of multiple point mosaics. Each window is clean to 5 times the rms noise level.
\end{description}
\end{description}

\section{What You Get from the Archive}
\begin{figure}[!ht]
\plotfiddle{part7/Friedel_P12/orion_spec.eps}{3in}{0}{28}{28}{-165}{-28}
\end{figure}
\begin{figure}[!ht]
\plotfiddle{part7/Friedel_P12/abs.eps}{-2in}{0}{30}{30}{30}{122}
\caption{(\textit{left}) Spectral line observation data of Orion-KL as produced by the \ssindex{data!pipelines!reduction}pipeline. (\textit{top right})An SZ \ssindex{astronomy!cluster!galaxy}cluster decrement at $\lambda$=1cm. (\textit{bottom right}) The point sources detected by the longer baselines that need to be subtracted in order to get the correct value for the decrement.\label{fig:SZD}}
\end{figure}
\begin{figure}[!ht]
\plotfiddle{part7/Friedel_P12/point.eps}{-2.0in}{0}{30}{30}{30}{75}
\end{figure}
The end user get a set of files that include:, fully calibrated \textit{u-v} data for all objects, continuum maps of both source(s) and primary gain calibrator, spectral data cubes for all source windows, the \ssindex{data!pipelines!reduction}pipeline \ssindex{computer languages!Python}Python files (so the \ssindex{data!pipelines!reduction}pipeline can be re-run at home), and a csh script that can reproduce exactly what was done to the data, so the end user can customize it and run it on their home system. These products are available through the \ssindex{archives!individual!CARMA}CARMA archive along with the raw data. Figure~\ref{fig:SZD} shows example output for a 3mm spectral line observation of Orion-KL and an SZ decrement observation.

\acknowledgements Support for \ssindex{observatories!Earth-based!CARMA}CARMA construction was derived from the Gordon and Betty Moore Foundation, the Kenneth T. and Eileen L. Norris Foundation, the James S. McDonnell Foundation, the Associates of the California Institute of Technology, the University of Chicago, the states of California, Illinois, and Maryland, and the National Science Foundation. Ongoing \ssindex{observatories!Earth-based!CARMA}CARMA development and operations are supported by the National Science Foundation under a cooperative agreement, and by the CARMA partner universities.

\bibliographystyle{asp2010}
\bibliography{editor}
